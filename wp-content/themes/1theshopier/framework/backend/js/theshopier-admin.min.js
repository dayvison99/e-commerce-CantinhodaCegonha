(function($){
	"use strict";
	
	var NTH_AD = {
		initialized: false,
		file_frame: false,
		initialize: function(){
			if (this.initialized) return;
			this.initialized = true;
			this.build();
			this.events();
		},
		build: function(){
			NTH_AD.metaBoxTemp();
		},
		events: function(){
			$('.nth-colorpicker, .nth_colorpicker').wpColorPicker();
			NTH_AD.mediaUpload();
			NTH_AD.megaMenu();
			NTH_AD.sidebarCreating();
		},
		metaBoxTemp: function(){
			$('.nth_be_tabs .nth_be_tabs_head .nth_item_head').on('click', function(e){
				e.preventDefault();
				if(!$(this).hasClass('current')){
					var id_ = $(this).find('a').attr('href');
					$(this).parent().find('.current').removeClass('current');
					$(this).addClass('current');
					$(this).parents('.nth_be_tabs').find('.nth_be_tabs_content > .nth_item_cont.active').removeClass('active');
					$(this).parents('.nth_be_tabs').find('.nth_be_tabs_content '+id_).addClass('active');
				}
			});

			$('.nth_be_subtabs .nth_be_subtabs_head .nth_item_head').on('click', function(e){
				e.preventDefault();
				if(!$(this).hasClass('current')){
					var id_ = $(this).find('a').attr('href');
					$(this).parent().find('.current').removeClass('current');
					$(this).addClass('current');
					$(this).parents('.nth_be_subtabs').find('.nth_be_subtabs_content > .nth_item_cont.active').removeClass('active');
					$(this).parents('.nth_be_subtabs').find('.nth_be_subtabs_content '+id_).addClass('active');
				}
			});

			$('.nth-field-request').each(function (e, i) {
				var element = $(this);
				var data = $(this).data('request');
				$(document).on('change', '#'+data.element, function () {
					if( data.values.indexOf($(this).val()) >= 0 ) {
						element.slideDown(300);
					} else {
						element.slideUp(300);
					}
				});
			});
		},
		mediaUpload: function(){
			$(document).on('click','.nth_upload_image_button',function(event){
				event.preventDefault();
				var $_this = $(this);
				var title = $_this.parents('.nth_upload_image').data('f_title');
				var text = $_this.parents('.nth_upload_image').data('f_btext');
				if( typeof title == 'undefined' ) title = "Choose an image";
				if( typeof text == 'undefined' ) text = "Use image";
				
				// If the media frame already exists, reopen it.
				if ( file_frame ) {
					file_frame.open();
					return;
				}
				
				// Create the media frame.
				var file_frame = wp.media.frames.downloadable_file = wp.media({
					title: title,
					button: {
						text: text
					},
					multiple: false
				});
				
				// When an image is selected, run a callback.
				file_frame.on( 'select', function() {
					var attachment = file_frame.state().get('selection').first().toJSON();
					$_this.parents('.nth_upload_image').find('.nth_image_id').val( attachment.id );
					if( attachment.sizes.hasOwnProperty('thumbnail') ) var src_ = attachment.sizes.thumbnail.url;
					else var src_ = attachment.sizes.full.url;
					$_this.parents('.nth_upload_image').find('.nth_thumbnail img').attr('src', src_ );
					$_this.parents('.nth_upload_image').find('.nth_remove_image_button').show();
				});
				
				// Finally, open the modal.
				file_frame.open();
				
			});
			
			$( document ).on( 'click', '.nth_remove_image_button', function( event ) {
				event.preventDefault();
				$(this).parents('.nth_upload_image').find('.nth_thumbnail img').attr('src', theshopier_data.media.images.f_default );
				$(this).parents('.nth_upload_image').find('.nth_image_id').val( '' );
				$(this).parents('.nth_upload_image').find('.nth_remove_image_button').hide();
			});
			
			//Media: audio, video.
			
			$( document ).on( 'click', '.upload_media_button', function( event ) {
				var $_this = $(this);
				event.preventDefault();
				
				var title = $_this.parents('.nth_upload_media').data('f_title');
				var text = $_this.parents('.nth_upload_media').data('f_btext');
				if( typeof title == 'undefined' ) title = "Choose an image";
				if( typeof text == 'undefined' ) text = "Use image";
				
				// If the media frame already exists, reopen it.
				if ( typeof file_frame != 'undefined' ) {
					file_frame.open();
					return;
				}
				
				// Create the media frame.
				var file_frame = wp.media.frames.downloadable_file = wp.media({
					title: title,
					button: {
						text: text
					},
					multiple: false
				});
				
				// When an image is selected, run a callback.
				file_frame.on( 'select', function() {
					var attachment = file_frame.state().get('selection').first().toJSON();
					$_this.parents('.nth_upload_media').find('.nth_media_output').val( attachment.url );
					$_this.parents('.nth_upload_media').find('.remove_media_button').removeClass('hidden');
				});
				
				// Finally, open the modal.
				file_frame.open();
				
			});
			
			$( document ).on( 'click', '.remove_media_button', function( event ) {
				event.preventDefault();
				$(this).parents('.nth_upload_media').find('.nth_media_output').val( '' );
				$(this).hide();
			});

			//public media button
			$(document).on("click", ".nth-media-video-upload .nth_media_upload_button", function(event){
				var $_this = $(this);
				event.preventDefault();

				// If the media frame already exists, reopen it.
				if ( typeof video_frame != 'undefined' ) {
					video_frame.open();
					return;
				}
				// Create the media frame.
				var video_frame = wp.media({
					frame: "video",
					state: "video-details",
					multiple: true
				});

				video_frame.on('update', function(){
					var data = [];
					data.attributes = video_frame.state().media.attributes
					data.extension = video_frame.state().media.extension;
					data.attachment = video_frame.state().media.attachment.attributes;
					var _incl = false;
					var _d_script = $_this.parent().find(".description");
					_d_script.html('');
					if ( typeof data.attributes.mp4 != 'undefined' ){
						$_this.parent().find(".nth_media_video_mp4").val(data.attributes.mp4);
						_incl = true;
						_d_script.append('<li>'+data.attributes.mp4+'</li>');
					}
					if ( typeof data.attributes.webm != 'undefined' ) {
						$_this.parent().find(".nth_media_video_webm").val(data.attributes.webm);
						_incl = true;
						_d_script.append('<li>'+data.attributes.webm+'</li>');
					}

					if ( typeof data.attributes.ogv != 'undefined' ) {
						$_this.parent().find(".nth_media_video_mp4").val(data.attributes.ogv);
						_incl = true;
						_d_script.append('<li>'+data.attributes.ogv+'</li>');
					}
					if ( typeof data.attributes.poster != 'undefined' )
						$_this.parent().find(".nth_media_video_poster").val(data.attributes.poster);
					if ( typeof data.attributes.autoplay != 'undefined' )
						$_this.parent().find(".nth_media_video_autoplay").val(data.attributes.autoplay);
					if ( typeof data.attributes.loop != 'undefined' )
						$_this.parent().find(".nth_media_video_loop").val(data.attributes.loop);

					if( _incl ) {
						$_this.parent().find(".nth_media_remove_button").show();
					}
				});

				// Finally, open the modal.
				video_frame.open();
			});

			$(document).on("click", ".nth-media-video-upload .nth_media_remove_button", function(event){
				event.preventDefault();
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_mp4").val('');
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_webm").val('');
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_ogv").val('');
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_poster").val('');
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_autoplay").val('');
				$(this).parents(".nth-media-video-upload").find(".nth_media_video_loop").val('');
				$(this).parents(".nth-media-video-upload").find("ul.description").html('');
				$(this).hide();
			});
		},
		megaMenu: function(){
			$('body').on('click','.edit-menu-item-mega',function(){
				if($(this).is(':checked')){
					$(this).parents('.menu-item-settings').find('.nth-meta-toggle').slideDown(300);
				} else {
					$(this).parents('.menu-item-settings').find('.nth-meta-toggle').slideUp(300);
				}
			});

		},
		ajax_call_btn: function () {
			$(document).on('click', '.nth-ajax-call', function(e){
				e.preventDefault();
				var param = $(this).data('param');
				var json = $(this).data('json') || 0;
				var $this = $(this);
				if( typeof param == 'undefined') return false;
				var args = {
					type: 'POST',
					url: ajaxurl,
					data: param,
					beforeSend: function(XMLHttpRequest){
						$this.trigger('_beforeSend');
					},
					success: function (o) {
						$this.trigger('_success', [o]);
					}
				}
				if( json && json !== 0 ) args.dataType = 'json';
				$.ajax(args);
			});

			var button_html = '';

			$(document).on('_beforeSend', '.nth-theme-import-wrapper .import-dummy .nth-ajax-call', function () {
				button_html = $(this).html();
				$(this).text('Importing...').removeClass('button-primary');
				$(this).prop('disabled', true);
				$(this).parents('.nth-theme-import-wrapper').addClass('importing');
			});
			$(document).on('_success', '.nth-theme-import-wrapper .import-dummy .nth-ajax-call', function (e, o) {
				$(this).parents('.nth-theme-import-wrapper').removeClass('importing');
				$(this).html(button_html).addClass('button-primary');
				$(this).prop('disabled', false);
				if(o == 'connect_error') {
					alert("Couldn't connect to server, please check your connection or contact with us");
					return false;
				}

				$(this).parents('.import-dummy').addClass('hidden');
				$(this).parents('.nth-theme-import-wrapper').find('.import-setting').removeClass('hidden');
				//$(this).remove();
			});

			$(document).on('_beforeSend', '.imported-current-home-wrapper .imported-items .nth-ajax-call', function () {
				$(this).text('Importing...').removeClass('button-primary');
				$(this).prop('disabled', true);
				$(this).parents('li').addClass('open');
				//$(this).parents('.import-home-wrapper').addClass('importing');
				$(this).parents('.nth-theme-import-wrapper').addClass('importing');
			});
			$(document).on('_success', '.imported-current-home-wrapper .imported-items .nth-ajax-call', function (e, o) {
				window.onbeforeunload = null;
				redux.args.ajax_save = false;

				if(o.status == 'connect_error') {
					alert("Couldn't connect to server, please check your connection or contact with us");
					window.location.reload(true);
					return false;
				} else if(o.status == 'rev_error') {
					alert("Couldn't download main slideshow for this home! please try again or contact with our support team.");
					window.location.reload(true);
					return false;
				}

				if( typeof $(this).data('ref') !== 'undefined' && $(this).data('ref').length > 0 ) {
					window.location.href = $(this).data('ref');
				} else {
					window.location.reload(true);
				}
			});

			$(document).on('click', '.nth-theme-import-wrapper .imported-current-home-wrapper .imported-item-list li.imported-item', function (e) {
				var __id = $(this).data('id');
				$(this).parent().find('li.open').removeClass('open');
				$(this).addClass('open');
				var img_wrap = $(this).parents('.imported-current-home-wrapper').find('.imported-current-home-image');
				img_wrap.find('.image-item:not(.hidden)').addClass('hidden');
				img_wrap.find(__id).removeClass('hidden');
			});
		},
		sidebarCreating: function () {
			if($('#nth_add_sidebar_form').length == 0 ) return;
			var sidebarForm = $('#nth_add_sidebar_form').clone();
			$('#nth_add_sidebar_form').remove();

			$('#widgets-right').append('<div style="clear:both;"></div>');
			$('#widgets-right').append(sidebarForm);

			sidebarForm.on('submit', function(e){
				e.preventDefault();
				var data =  {
					'action':'nth_add_widgetsidebar',
					'_wpnonce_nth_add_sidebar': $('#_wpnonce_nth_add_sidebar').val(),
					'sidebar_name': $('#sidebar_name').val(),
					'sidebar_desc': $('#sidebar_desc').val(),
				};

				$.ajax({
					url: ajaxurl,
					type: "POST",
					data: data,
					beforeSend: function(){
						sidebarForm.find('[type=submit]').attr('disabled', true);
					},
					success: function(o){
						if('success' == o) window.location.reload(true);
						else {
							sidebarForm.find('[type=submit]').removeAttr('disabled');
							sidebarForm.find('.mesg-form').html('<span>'+o+'</span>' ).slideDown(200);
							window.setTimeout(function(){
								sidebarForm.find('.mesg-form').slideUp(200);
							},8000);
						}
					}
				});
			});

			$('.sidebar-nth-custom-sidebar-arrow').find('.sidebar-name-arrow').before('<div class="delete-sidebar ready"><i class="dashicons-trash dashicons-before"></i></div>');

			$('#widgets-right').on('click', '.delete-sidebar.ready', function(e){
				var $_this = $(this);
				var confirmIt = confirm('Are you sure?');
				if(!confirmIt) return;
				var widget_id = $(this).parent().parent().attr('id');
				var data =  {
					'action':'nth_del_widgetsidebar',
					'sidebar_id': widget_id,
				};

				$.ajax({
					url: ajaxurl,
					type: "POST",
					data: data,
					beforeSend: function(){
						$_this.removeClass('ready');
					},
					success: function(o){
						window.location.reload(true);
					}
				});
			});
		}
	}
	
	$(document).ready(function(e) {
		NTH_AD.initialize();
	});

})(jQuery)


